<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Master | Student Community</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body { font-family: 'Outfit', sans-serif; background-color: #050505; color: #e5e5e5; }
        .glass { background: rgba(30, 30, 30, 0.4); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .input-base { background: #111; border: 1px solid #222; color: white; padding: 0.5rem; border-radius: 0.5rem; width: 100%; outline: none; transition: 0.2s; font-size: 0.875rem; }
        .input-base:focus { border-color: #8b5cf6; }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
    </style>
</head>
<body class="min-h-screen p-6 relative overflow-hidden flex flex-col h-screen">
    <div id="app" class="max-w-[1600px] mx-auto w-full h-full flex flex-col">
        
        <!-- Header -->
        <header class="flex justify-between items-center mb-6 shrink-0">
             <div class="flex items-center gap-3">
                 <div class="w-10 h-10 rounded-lg bg-violet-600 flex items-center justify-center text-white shadow-lg shadow-violet-500/30"><i class="fa-solid fa-list-check text-lg"></i></div>
                <div>
                    <h1 class="text-xl font-bold bg-gradient-to-r from-violet-400 to-fuchsia-400 bg-clip-text text-transparent">Quiz Master</h1>
                    <p class="text-xs text-gray-500">Create & Take Quizzes</p>
                </div>
            </div>
            
            <div v-if="mode === 'home'" class="flex gap-3">
                 <div class="relative">
                    <i class="fa-solid fa-search absolute left-3 top-2.5 text-gray-500 text-xs"></i>
                    <input v-model="search" class="input-base pl-8 w-64 border-[#333]" placeholder="Search quizzes...">
                </div>
                <button @click="createQuiz" class="px-4 py-2 rounded-lg bg-[#222] hover:bg-[#333] border border-[#333] text-sm text-gray-300 hover:text-white transition">+ Create Quiz</button>
                <button @click="saveFile" class="px-4 py-2 rounded-lg bg-violet-600 hover:bg-violet-500 text-white text-sm font-bold shadow-lg shadow-violet-500/20 transition">Save All</button>
            </div>
            <div v-else class="flex gap-3">
                <button @click="mode = 'home'" class="px-4 py-2 rounded-lg bg-[#222] text-gray-300 text-sm hover:text-white border border-[#333]"><i class="fa-solid fa-arrow-left mr-2"></i>Back to Home</button>
                <button v-if="mode === 'edit'" @click="saveFile" class="px-4 py-2 rounded-lg bg-violet-600 text-white text-sm font-bold">Save Quiz</button>
            </div>
        </header>

        <!-- VIEW: Home (Quiz List) -->
        <div v-if="mode === 'home'" class="flex-1 overflow-y-auto">
            <div v-if="filteredQuizzes.length === 0" class="flex flex-col items-center justify-center h-full text-gray-600">
                <i class="fa-solid fa-clipboard-question text-6xl mb-4 opacity-20"></i>
                <p>No quizzes found. Create one!</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div v-for="quiz in filteredQuizzes" :key="quiz.id" class="glass rounded-xl p-6 hover:border-violet-500/30 transition group relative flex flex-col h-64">
                    <button @click="deleteQuiz(quiz.id)" class="absolute top-4 right-4 text-gray-600 hover:text-red-500 opacity-0 group-hover:opacity-100 transition"><i class="fa-solid fa-trash"></i></button>
                    
                    <h2 class="text-xl font-bold text-white mb-2 truncate">{{ quiz.title }}</h2>
                    <div class="flex gap-2 mb-4">
                        <span v-for="tag in quiz.tags" :key="tag" class="text-[10px] bg-[#222] text-gray-400 px-2 py-1 rounded border border-[#333]">{{ tag }}</span>
                    </div>
                    <p class="text-xs text-gray-500 line-clamp-3 mb-auto">{{ quiz.desc || 'No description provided.' }}</p>
                    
                    <div class="mt-4 flex gap-3 border-t border-[#222] pt-4">
                        <button @click="editQuiz(quiz)" class="flex-1 py-2 bg-[#1a1a1a] hover:bg-[#222] text-gray-300 rounded-lg text-xs font-bold transition border border-[#333]">Edit Quiz</button>
                        <button @click="takeQuiz(quiz)" class="flex-1 py-2 bg-violet-600 hover:bg-violet-500 text-white rounded-lg text-xs font-bold transition shadow-lg shadow-violet-600/20">Start ({{ quiz.questions.length }})</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW: Edit Quiz -->
        <div v-else-if="mode === 'edit'" class="flex-1 flex gap-6 overflow-hidden">
             <!-- Sidebar: Questions -->
             <div class="w-64 bg-[#0a0a0a] border border-[#222] rounded-xl flex flex-col overflow-hidden">
                 <div class="p-4 border-b border-[#222] bg-[#111]">
                     <input v-model="activeQuiz.title" class="bg-transparent text-sm font-bold text-white w-full outline-none" placeholder="Quiz Title">
                 </div>
                 <div class="flex-1 overflow-y-auto p-2 space-y-1">
                     <div v-for="(q, idx) in activeQuiz.questions" :key="idx" 
                        @click="activeQuestionIndex = idx"
                        :class="['p-2 rounded cursor-pointer text-xs flex justify-between group', activeQuestionIndex === idx ? 'bg-violet-900/20 text-violet-400 border border-violet-500/20' : 'text-gray-400 hover:bg-[#151515]']">
                        <span>Q{{ idx + 1 }}. {{ q.type }}</span>
                        <button @click.stop="activeQuiz.questions.splice(idx, 1)" class="opacity-0 group-hover:opacity-100 hover:text-red-500"><i class="fa-solid fa-times"></i></button>
                     </div>
                 </div>
                 <button @click="addQuestion" class="p-3 bg-[#151515] hover:bg-[#222] text-gray-400 text-xs font-bold border-t border-[#222] transition">+ Add Question</button>
             </div>

             <!-- Main Editor -->
             <div class="flex-1 bg-[#0a0a0a] border border-[#222] rounded-xl flex flex-col overflow-hidden">
                 <div v-if="currentQuestion" class="flex-1 flex flex-col">
                     <!-- Toolbar -->
                     <div class="p-4 border-b border-[#222] bg-[#111] flex justify-between items-center">
                         <div class="flex items-center gap-4">
                             <span class="text-sm font-bold text-gray-400">Question {{ activeQuestionIndex + 1 }}</span>
                             <select v-model="currentQuestion.type" class="bg-[#222] text-xs text-white px-2 py-1 rounded border border-[#333] outline-none">
                                 <option value="mcq">Single Choice (MCQ)</option>
                                 <option value="msq">Multiple Choice (MSQ)</option>
                                 <option value="boolean">True / False</option>
                                 <option value="numeric">Numeric</option>
                             </select>
                         </div>
                         <div class="flex gap-2">
                             <button @click="currentQuestion.preview = !currentQuestion.preview" class="text-xs text-gray-500 hover:text-white px-2"><i :class="['fa-solid', currentQuestion.preview ? 'fa-eye' : 'fa-pen']"></i> {{ currentQuestion.preview ? 'Preview' : 'Edit' }}</button>
                         </div>
                     </div>

                     <!-- Content -->
                     <div class="flex-1 overflow-y-auto p-8 max-w-4xl mx-auto w-full space-y-8">
                         
                         <!-- Question Text -->
                         <div>
                             <label class="text-xs font-bold text-gray-500 uppercase mb-2 block">Question Text (Markdown)</label>
                             <div v-if="currentQuestion.preview" class="p-4 bg-[#151515] rounded-lg border border-[#222] prose prose-invert prose-sm" v-html="renderMd(currentQuestion.text)"></div>
                             <textarea v-else v-model="currentQuestion.text" class="input-base h-32 resize-none font-sans" placeholder="# Question here..."></textarea>
                         </div>

                         <!-- Options Area -->
                         <div class="glass p-6 rounded-xl border border-[#222]">
                             <h3 class="text-sm font-bold text-white mb-4 uppercase">Answer Configuration</h3>
                             
                             <!-- MCQ / MSQ -->
                             <div v-if="['mcq', 'msq'].includes(currentQuestion.type)" class="space-y-3">
                                 <div v-for="(opt, idx) in currentQuestion.options" :key="idx" class="flex gap-3 items-center">
                                     <!-- Selector -->
                                     <input v-if="currentQuestion.type === 'mcq'" type="radio" :name="'q'+activeQuestionIndex" :checked="opt.isCorrect" @change="setMcqCorrect(idx)" class="accent-violet-500 w-4 h-4 cursor-pointer">
                                     <input v-if="currentQuestion.type === 'msq'" type="checkbox" v-model="opt.isCorrect" class="accent-violet-500 w-4 h-4 cursor-pointer">
                                     
                                     <!-- Input -->
                                     <input v-model="opt.text" class="flex-1 input-base py-1.5" placeholder="Option text (Markdown supported)">
                                     
                                     <button @click="currentQuestion.options.splice(idx, 1)" class="text-gray-600 hover:text-red-500"><i class="fa-solid fa-times"></i></button>
                                 </div>
                                 <button @click="currentQuestion.options.push({text:'', isCorrect: false})" class="text-xs text-violet-400 hover:text-violet-300 font-bold mt-2">+ Add Option</button>
                             </div>

                             <!-- Boolean -->
                             <div v-if="currentQuestion.type === 'boolean'" class="flex gap-4">
                                 <button @click="currentQuestion.answer = true" :class="['px-6 py-2 rounded-lg border transition', currentQuestion.answer === true ? 'bg-green-600 border-green-500 text-white' : 'bg-[#1a1a1a] border-[#333] text-gray-400']">True</button>
                                 <button @click="currentQuestion.answer = false" :class="['px-6 py-2 rounded-lg border transition', currentQuestion.answer === false ? 'bg-red-600 border-red-500 text-white' : 'bg-[#1a1a1a] border-[#333] text-gray-400']">False</button>
                             </div>

                             <!-- Numeric -->
                             <div v-if="currentQuestion.type === 'numeric'">
                                 <label class="text-[10px] text-gray-500 font-bold mb-1 block">Correct Number</label>
                                 <input v-model="currentQuestion.answer" type="number" class="input-base w-48" placeholder="e.g. 42">
                             </div>
                         </div>
                         
                         <!-- Metadata -->
                         <div class="grid grid-cols-2 gap-6">
                             <div>
                                 <label class="text-xs font-bold text-gray-500 uppercase mb-2 block">Explanation / Hint</label>
                                 <textarea v-model="currentQuestion.explanation" class="input-base h-24 resize-none" placeholder="Explain why..."></textarea>
                             </div>
                             <div>
                                 <label class="text-xs font-bold text-gray-500 uppercase mb-2 block">Tags</label>
                                 <input v-model="activeQuiz.tags" class="input-base" placeholder="Math, Logic (comma sep) - applies to quiz">
                             </div>
                         </div>

                     </div>
                 </div>
                 <div v-else class="flex-1 flex items-center justify-center text-gray-600">
                     Select or add a question
                 </div>
             </div>
        </div>

        <!-- VIEW: Take Quiz -->
        <div v-else-if="mode === 'take'" class="flex-1 flex flex-col max-w-3xl mx-auto w-full">
            <div class="bg-[#0a0a0a] border border-[#222] rounded-xl p-8 flex-1 flex flex-col shadow-2xl">
                <!-- Progress -->
                <div class="flex justify-between items-center mb-6">
                    <span class="text-xs font-mono text-gray-500">Question {{ currentTakeIndex + 1 }} / {{ activeQuiz.questions.length }}</span>
                    <span class="text-xs font-bold text-violet-400">{{ activeQuiz.title }}</span>
                </div>
                
                <!-- Question -->
                <div class="flex-1 overflow-y-auto mb-6">
                    <div class="prose prose-invert prose-lg mb-8" v-html="renderMd(currentTakeQuestion.text)"></div>
                    
                    <!-- Options -->
                    <div class="space-y-3">
                        <div v-if="['mcq', 'msq'].includes(currentTakeQuestion.type)">
                            <div v-for="(opt, idx) in currentTakeQuestion.options" :key="idx" 
                                @click="toggleOption(opt)"
                                :class="['p-4 rounded-lg border cursor-pointer transition flex items-center gap-3', isSelected(opt) ? 'bg-violet-900/20 border-violet-500 text-white' : 'bg-[#151515] border-[#222] text-gray-300 hover:border-gray-500']">
                                <div :class="['w-5 h-5 rounded border flex items-center justify-center', isSelected(opt) ? 'bg-violet-600 border-violet-600' : 'border-gray-500']">
                                    <i v-if="isSelected(opt)" class="fa-solid fa-check text-[10px] text-white"></i>
                                </div>
                                <div class="text-sm" v-html="renderMd(opt.text)"></div>
                            </div>
                        </div>
                        
                        <div v-if="currentTakeQuestion.type === 'boolean'" class="flex gap-4">
                             <button @click="userAnswers[currentTakeIndex] = true" :class="['flex-1 p-4 rounded-lg border font-bold', userAnswers[currentTakeIndex] === true ? 'bg-violet-600 border-violet-500 text-white' : 'bg-[#151515] border-[#222] text-gray-400']">True</button>
                             <button @click="userAnswers[currentTakeIndex] = false" :class="['flex-1 p-4 rounded-lg border font-bold', userAnswers[currentTakeIndex] === false ? 'bg-violet-600 border-violet-500 text-white' : 'bg-[#151515] border-[#222] text-gray-400']">False</button>
                        </div>

                         <div v-if="currentTakeQuestion.type === 'numeric'">
                             <input v-model="userAnswers[currentTakeIndex]" type="number" class="input-base text-xl p-4" placeholder="Enter number...">
                         </div>
                    </div>
                </div>

                <!-- Nav -->
                <div class="flex justify-between border-t border-[#222] pt-6">
                    <button :disabled="currentTakeIndex === 0" @click="currentTakeIndex--" class="px-6 py-2 rounded-lg bg-[#222] text-gray-300 disabled:opacity-50">Previous</button>
                    <button v-if="currentTakeIndex < activeQuiz.questions.length - 1" @click="currentTakeIndex++" class="px-6 py-2 rounded-lg bg-white text-black font-bold hover:bg-gray-200">Next</button>
                    <button v-else @click="submitQuiz" class="px-6 py-2 rounded-lg bg-green-500 hover:bg-green-400 text-black font-bold shadow-lg shadow-green-500/20">Submit</button>
                </div>
            </div>
        </div>

        <!-- VIEW: Results -->
        <div v-else-if="mode === 'result'" class="flex-1 overflow-y-auto max-w-3xl mx-auto w-full">
            <div class="bg-[#0a0a0a] border border-[#222] rounded-xl p-8 mb-6 text-center">
                <h2 class="text-3xl font-bold text-white mb-2">Score: {{ score }} / {{ activeQuiz.questions.length }}</h2>
                <div class="w-full bg-[#222] h-2 rounded-full overflow-hidden mb-6">
                    <div class="bg-green-500 h-full" :style="{width: (score/activeQuiz.questions.length)*100 + '%'}"></div>
                </div>
                <button @click="mode='home'" class="px-6 py-2 rounded-lg bg-[#222] hover:bg-[#333] text-white">Back to List</button>
            </div>
            
            <div class="space-y-6">
                <div v-for="(q, idx) in activeQuiz.questions" :key="idx" class="glass p-6 rounded-xl border border-[#222]">
                    <div class="flex items-center gap-2 mb-2">
                        <span :class="['w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold', results[idx].isCorrect ? 'bg-green-500 text-black' : 'bg-red-500 text-black']">
                            <i :class="['fa-solid', results[idx].isCorrect ? 'fa-check' : 'fa-times']"></i>
                        </span>
                        <span class="text-gray-400 text-sm font-bold">Question {{ idx + 1 }}</span>
                    </div>
                    <div class="prose prose-invert prose-sm mb-4" v-html="renderMd(q.text)"></div>
                    
                    <div class="bg-[#111] p-4 rounded text-xs text-gray-300">
                        <strong class="text-gray-500 uppercase block mb-1">Your Answer:</strong> 
                        {{ formatAnswer(userAnswers[idx]) }}
                    </div>
                    <div v-if="!results[idx].isCorrect" class="mt-2 bg-[#1a0f0f] p-4 rounded text-xs text-red-200 border border-red-900/30">
                         <strong class="text-red-500 uppercase block mb-1">Correction / Explanation:</strong>
                         {{ q.explanation || 'No explanation provided.' }}
                    </div>
                </div>
            </div>
        </div>

        <!-- Notification -->
        <div v-if="notification" class="fixed top-6 right-6 z-50 px-4 py-3 rounded-lg shadow-xl border border-gray-700 bg-gray-900 text-white flex items-center gap-3 animate-fade-in">
            <span class="text-violet-400">âœ“</span> {{ notification }}
        </div>
    </div>

    <script>
        const { createApp } = Vue;
        createApp({
            data() {
                return {
                    quizzes: [],
                    activeQuiz: null,
                    mode: 'home', // home, edit, take, result
                    search: '',
                    activeQuestionIndex: 0,
                    
                    // Taking Quiz State
                    currentTakeIndex: 0,
                    userAnswers: [], // Array matching questions index
                    score: 0,
                    results: [], // { isCorrect: bool }

                    notification: null
                }
            },
            computed: {
                filteredQuizzes() {
                    const q = this.search.toLowerCase();
                    return this.quizzes.filter(x => x.title.toLowerCase().includes(q));
                },
                currentQuestion() {
                    if(!this.activeQuiz || !this.activeQuiz.questions) return null;
                    return this.activeQuiz.questions[this.activeQuestionIndex];
                },
                currentTakeQuestion() {
                     return this.activeQuiz.questions[this.currentTakeIndex];
                }
            },
            mounted() { this.loadFile(); },
            methods: {
                async loadFile() {
                    try {
                        const res = await fetch('./questions.json');
                        if (res.ok) {
                            let data = await res.json();
                            // Detect old format (array of questions) vs new format (array of quizzes)
                            if (data.length > 0 && data[0].questions) {
                                this.quizzes = data;
                            } else if (data.length > 0) {
                                // Migration: Wrap old questions in a "Default Quiz"
                                this.quizzes = [{
                                    id: 'default', title: 'Migrated Quiz', tags: ['Old'], desc: 'Auto-migrated',
                                    questions: data
                                }];
                            } else {
                                this.quizzes = [];
                            }
                        }
                    } catch (e) { this.quizzes = []; }
                },
                createQuiz() {
                    const newQuiz = {
                        id: Date.now().toString(),
                        title: 'New Quiz',
                        tags: [],
                        desc: '',
                        questions: []
                    };
                    this.quizzes.push(newQuiz);
                    this.editQuiz(newQuiz);
                },
                editQuiz(q) {
                    this.activeQuiz = q;
                    this.mode = 'edit';
                    this.activeQuestionIndex = 0;
                    if(q.questions.length === 0) this.addQuestion();
                },
                deleteQuiz(id) {
                    if(confirm("Delete this quiz?")) this.quizzes = this.quizzes.filter(q => q.id !== id);
                },
                addQuestion() {
                    this.activeQuiz.questions.push({
                        type: 'mcq',
                        text: '',
                        options: [{text:'', isCorrect:false}, {text:'', isCorrect:false}],
                        answer: null, // For boolean/numeric
                        explanation: '',
                        preview: false
                    });
                    this.activeQuestionIndex = this.activeQuiz.questions.length - 1;
                },
                setMcqCorrect(idx) {
                    this.currentQuestion.options.forEach((o, i) => o.isCorrect = (i === idx));
                },
                
                // Taking Logic
                takeQuiz(q) {
                    this.activeQuiz = q;
                    this.mode = 'take';
                    this.currentTakeIndex = 0;
                    this.userAnswers = new Array(q.questions.length).fill(null);
                    if(q.questions.length === 0) { alert("No questions!"); this.mode='home'; }
                },
                toggleOption(opt) {
                    if(this.currentTakeQuestion.type === 'mcq') {
                        this.userAnswers[this.currentTakeIndex] = [opt];
                    } else { // MSQ
                        let ans = this.userAnswers[this.currentTakeIndex] || [];
                        if (ans.includes(opt)) ans = ans.filter(o => o !== opt);
                        else ans.push(opt);
                        this.userAnswers[this.currentTakeIndex] = ans;
                    }
                },
                isSelected(opt) {
                    const ans = this.userAnswers[this.currentTakeIndex];
                    if(!ans) return false;
                    return ans.includes(opt);
                },
                submitQuiz() {
                    let s = 0;
                    this.results = this.activeQuiz.questions.map((q, idx) => {
                        const userAns = this.userAnswers[idx];
                        let isCorrect = false;

                        if (q.type === 'mcq') {
                            // userAns is array of selected option obj
                            if(userAns && userAns.length > 0 && userAns[0].isCorrect) isCorrect = true;
                        } else if (q.type === 'msq') {
                            // userAns is array. Check if all correct options are selected and no wrong ones.
                            const selected = userAns || [];
                            const correctOpts = q.options.filter(o => o.isCorrect);
                            const wrongOpts = q.options.filter(o => !o.isCorrect);
                            
                            const capturedAll = correctOpts.every(o => selected.includes(o));
                            const avoidedWrong = wrongOpts.every(o => !selected.includes(o));
                            if(capturedAll && avoidedWrong) isCorrect = true;

                        } else if (q.type === 'boolean') {
                             if(userAns === q.answer) isCorrect = true;
                        } else if (q.type === 'numeric') {
                             if(parseFloat(userAns) === parseFloat(q.answer)) isCorrect = true;
                        }

                        if(isCorrect) s++;
                        return { isCorrect };
                    });

                    this.score = s;
                    this.mode = 'result';
                },
                formatAnswer(ans) {
                    if(Array.isArray(ans)) return ans.map(a => a.text).join(', ');
                    return ans;
                },

                renderMd(t) { return t ? marked.parse(t) : ''; },
                async saveFile() {
                    try {
                        if (window.showSaveFilePicker) {
                            const handle = await window.showSaveFilePicker({ suggestedName: 'questions.json' });
                            const writable = await handle.createWritable();
                            await writable.write(JSON.stringify(this.quizzes, null, 2));
                            await writable.close();
                            this.showNotification('Quizzes Saved');
                        } else {
                            const blob = new Blob([JSON.stringify(this.quizzes, null, 2)], {type: 'application/json'});
                            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'questions.json'; a.click();
                            this.showNotification('Quizzes Downloaded');
                        }
                    } catch (err) { console.error(err); }
                },
                showNotification(msg) { this.notification = msg; setTimeout(() => this.notification = null, 3000); }
            }
        }).mount('#app');
    </script>
</body>
</html>
